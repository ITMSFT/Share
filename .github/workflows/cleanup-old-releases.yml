name: Auto Delete Old Releases

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –¥–ª—è —Ç–µ—Å—Ç–∞

jobs:
  cleanup-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Delete releases older than 2 days
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // –†–µ–ª–∏–∑—ã —Å—Ç–∞—Ä—à–µ 2 –¥–Ω–µ–π –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã
            const daysToKeep = 2;
            const now = new Date();
            
            console.log(`üîç Checking releases in ${owner}/${repo}`);
            console.log(`‚è∞ Current time: ${now.toISOString()}`);
            console.log(`üóëÔ∏è  Will delete releases older than ${daysToKeep} days`);
            
            try {
              // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ä–µ–ª–∏–∑—ã
              const releases = await github.rest.repos.listReleases({
                owner,
                repo,
                per_page: 100
              });
              
              console.log(`üì¶ Found ${releases.data.length} release(s)`);
              
              let deletedCount = 0;
              
              for (const release of releases.data) {
                const createdAt = new Date(release.created_at);
                const ageInDays = (now - createdAt) / (1000 * 60 * 60 * 24);
                
                console.log(`\nüìã Release: "${release.name || release.tag_name}"`);
                console.log(`   Tag: ${release.tag_name}`);
                console.log(`   Created: ${createdAt.toISOString()}`);
                console.log(`   Age: ${ageInDays.toFixed(2)} days`);
                
                if (ageInDays > daysToKeep) {
                  console.log(`   ‚ùå DELETING (older than ${daysToKeep} days)`);
                  
                  try {
                    // –£–¥–∞–ª—è–µ–º —Ä–µ–ª–∏–∑
                    await github.rest.repos.deleteRelease({
                      owner,
                      repo,
                      release_id: release.id
                    });
                    
                    console.log(`   ‚úÖ Release deleted successfully`);
                    
                    // –£–¥–∞–ª—è–µ–º —Ç–∞–∫–∂–µ –∏ —Ç–µ–≥
                    try {
                      await github.rest.git.deleteRef({
                        owner,
                        repo,
                        ref: `tags/${release.tag_name}`
                      });
                      console.log(`   ‚úÖ Tag deleted successfully`);
                    } catch (tagError) {
                      console.log(`   ‚ö†Ô∏è  Tag not found or already deleted: ${tagError.message}`);
                    }
                    
                    deletedCount++;
                    
                  } catch (deleteError) {
                    console.error(`   ‚ùå Failed to delete release: ${deleteError.message}`);
                  }
                } else {
                  console.log(`   ‚úÖ Keeping (still fresh)`);
                }
              }
              
              console.log(`\n\nüìä Summary:`);
              console.log(`   Total releases checked: ${releases.data.length}`);
              console.log(`   Releases deleted: ${deletedCount}`);
              console.log(`   Releases kept: ${releases.data.length - deletedCount}`);
              
            } catch (error) {
              console.error(`‚ùå Error: ${error.message}`);
              throw error;
            }
